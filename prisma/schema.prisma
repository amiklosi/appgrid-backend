// License Key Management System Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id               String   @id @default(uuid())
  email            String   @unique
  name             String?
  company          String?
  marketingConsent Boolean? @map("marketing_consent")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  licenses            License[]
  revenueCatMigrations RevenueCatMigration[]
  paddlePurchases     PaddlePurchase[]

  @@map("users")
}

enum LicenseStatus {
  ACTIVE
  EXPIRED
  REVOKED
  SUSPENDED
}

model License {
  id             String        @id @default(uuid())
  userId         String        @map("user_id")
  licenseKey     String        @unique @map("license_key")
  status         LicenseStatus @default(ACTIVE)
  issuedAt       DateTime      @default(now()) @map("issued_at")
  expiresAt      DateTime?     @map("expires_at")
  activatedAt    DateTime?     @map("activated_at")
  revokedAt      DateTime?     @map("revoked_at")
  maxActivations Int           @default(1) @map("max_activations")
  metadata       Json?
  notes          String?
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  user                 User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  validations          LicenseValidation[]
  revenueCatMigrations RevenueCatMigration[]
  paddlePurchases      PaddlePurchase[]
  deviceActivations    DeviceActivation[]

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("licenses")
}

model LicenseValidation {
  id                String   @id @default(uuid())
  licenseId         String   @map("license_id")
  isValid           Boolean  @map("is_valid")
  validationMessage String?  @map("validation_message")
  ipAddress         String?  @map("ip_address")
  userAgent         String?  @map("user_agent")
  deviceFingerprint String?  @map("device_fingerprint")
  createdAt         DateTime @default(now()) @map("created_at")

  license License @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  @@index([licenseId])
  @@index([createdAt])
  @@map("license_validations")
}

model RevenueCatMigration {
  id                  String   @id @default(uuid())
  revenueCatUserId    String   @unique @map("revenuecat_user_id")
  email               String
  licenseId           String   @map("license_id")
  userId              String   @map("user_id")
  emailSent           Boolean  @default(false) @map("email_sent")
  emailSentAt         DateTime? @map("email_sent_at")
  revenueCatData      Json?    @map("revenuecat_data")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  license License @relation(fields: [licenseId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([revenueCatUserId])
  @@index([createdAt])
  @@map("revenuecat_migrations")
}

model PaddlePurchase {
  id                  String   @id @default(uuid())
  paddleTransactionId String   @unique @map("paddle_transaction_id")
  paddleCustomerId    String?  @map("paddle_customer_id")
  email               String
  licenseId           String   @map("license_id")
  userId              String   @map("user_id")
  emailSent           Boolean  @default(false) @map("email_sent")
  emailSentAt         DateTime? @map("email_sent_at")
  paddleData          Json?    @map("paddle_data")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  license License @relation(fields: [licenseId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([paddleTransactionId])
  @@index([paddleCustomerId])
  @@index([createdAt])
  @@map("paddle_purchases")
}

model DeviceActivation {
  id                String   @id @default(uuid())
  licenseId         String   @map("license_id")
  deviceFingerprint String   @map("device_fingerprint")
  deviceName        String?  @map("device_name")
  ipAddress         String?  @map("ip_address")
  userAgent         String?  @map("user_agent")
  activatedAt       DateTime @default(now()) @map("activated_at")
  lastSeenAt        DateTime @updatedAt @map("last_seen_at")

  license License @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  @@unique([licenseId, deviceFingerprint])
  @@index([licenseId])
  @@index([deviceFingerprint])
  @@map("device_activations")
}

enum WebhookStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  RETRYING
}

model WebhookEvent {
  id            String        @id @default(uuid())
  source        String        // 'paddle', 'revenuecat', etc.
  eventType     String        @map("event_type")
  eventId       String?       @map("event_id") // External event ID (e.g., Paddle transaction ID)
  payload       Json
  status        WebhookStatus @default(PENDING)
  attempts      Int           @default(0)
  lastError     String?       @map("last_error")
  lastAttemptAt DateTime?     @map("last_attempt_at")
  completedAt   DateTime?     @map("completed_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@unique([source, eventId])
  @@index([status])
  @@index([source, eventType])
  @@index([createdAt])
  @@map("webhook_events")
}

enum EmailStatus {
  PENDING
  SENDING
  SENT
  FAILED
  RETRYING
}

model EmailQueue {
  id              String      @id @default(uuid())
  to              String
  subject         String
  textContent     String      @map("text_content")
  htmlContent     String      @map("html_content")
  status          EmailStatus @default(PENDING)
  attempts        Int         @default(0)
  maxAttempts     Int         @default(5) @map("max_attempts")
  lastError       String?     @map("last_error")
  lastAttemptAt   DateTime?   @map("last_attempt_at")
  nextRetryAt     DateTime?   @map("next_retry_at")
  sentAt          DateTime?   @map("sent_at")
  messageId       String?     @map("message_id")
  metadata        Json?       // Store context like licenseId, purchaseId, etc.
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@index([status])
  @@index([nextRetryAt])
  @@index([createdAt])
  @@map("email_queue")
}
